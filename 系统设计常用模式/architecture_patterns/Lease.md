# Lease (租约模式)

一种用于在多节点的分布式环境下，以“有效期”为核心来管理分布式锁或资源所有权的协议。它完美地解决了由于进程崩溃、网络卡顿引发的 **“资源死锁无法释放”** 的难题。

## 1. 痛点：僵死的锁持有者

当你使用普通的分布式锁（如基于 Redis 的 SETNX）时：

**灾难场景**：
1.  **节点 A 抢到锁**：开始执行一个超大的结算任务。
2.  **中途挂了**：代码运行了一半，节点 A 突然发生 OOM 或所在物理机断电。
3.  **后果**：这个锁在 Redis 里依然存在。如果没有人能去释放它。
4.  **死局**：其他健康的节点 B, C 会认为锁还在被人用。结果这个结算任务永远卡在这里，导致业务全线停摆。

**本质原因**：在分布式中，一个节点可能在任何时刻由于任何原因消失。**永不过期的凭证是极度危险的。**

---

## 2. 解决方案：临时产权与自动收回

租约给权力加了一个 **时间轴 (TTL)**。

### 核心逻辑
1.  **颁发租约**：中心（Server）发给节点 A 一个租约，有效期 10 秒。
2.  **续租 (Renewal)**：节点 A 只要活着。每隔 3 秒就去给中心发一个心跳包：`“我还活着，请再延 10 秒。”`
3.  **自动失效**：如果 A 崩溃或者网络断了（没发心跳）。中心等 10 秒后，发现租约超时。
4.  **资源回收**：中心判定 A 已失能。此时它可以安全地把资源分配给申请者 B。

---

## 3. 典型应用场景

### A. 分布式锁 (etcd / Zookeeper)
etcd 的核心就是租约。你创建一个 Key 时必须绑定一个 Lease ID。

### B. DHCP (分配 IP)
你的电脑连接路由器。路由器分给你 192.168.1.100，租期 2 小时。如果你关机下班了，租约一过。这个 IP 就能给明天来的同事用。

### C. 强一致性缓存
服务器告知客户端：`“这条配置数据你可以缓存。租期 60 秒。这 60 秒内我保证不改。如果我要改，我也要先等你的租约过期后再改。”`

---

## 4. 关键挑战：时钟漂移与网络瞬间卡顿

1.  **时钟不准**：如果节点 A 的表慢了 1 分钟。会导致极其严重的逻辑判断错误。**租约强依赖于时间的同步（NTP）。**
2.  **假性丢失**：节点 A 正在写代码，突然 GC 停顿了 15 秒。租约过期了。等 A 醒来继续写时。资源已经被分给 B 了。
    *   **处理建议**：在执行写 DB 这种破坏性操作前。必须再次检查租约是否仍然在有效期内。

---

## 5. 常见策略：续租时间比例

业界公认比例：**T / 3**。
即租期 10 秒。每 3.3 秒续租一次。
这样即使你丢一两个网络包，你还有两次机会在租约正式过期前补救成功。

## 6. 总结
租约是分布式治理的 **“耐性”**。
*   **信条**：只有活着的、能说话的节点才有资格持有产权。
*   **一句话口诀**：限时持有权限，必须按期续约。
