# Throttling (分级节流模式)

在资源受限的环境下，根据请求的优先级、用户身份或实时负载情况，动态地限制或调整服务质量（QoS）的模式。它比普通限流更灵活，强调 **“差别对待”**。

## 1. 痛点：不公平的资源侵占

在多租户（SaaS）系统或共享资源池中，经常发生这几种情况：

*   **免费用户打败付费用户**：100 万个免费用户发起的轻量查询，占满了带宽和 IO，导致唯一的付费老客户点击“支付”时卡顿。
*   **内部测试拖垮生产**：内部报表导出任务，因为数据量大，竟然把线上支付接口的 CPU 给占满了。
*   **低优逻辑干扰核心**：发送营销短信的后台逻辑如果写得不好，导致用户找回密码的验证码发不出去。

**结论**：如果系统把所有请求视为平等的，那对最重要的客户来说就是不公平的。

---

## 2. 解决方案：差异化资源调度

Throttling 通过建立阶梯式的限制规则来实现保护：

### 维度 A: 基于身份 (Identity-based)
*   **普通用户**：每 10 秒限流 1 次。
*   **VIP 用户**：每秒 100 次（不限流）。

### 维度 B: 基于业务重要性 (Business Priority)
当系统总负载达到 80% 时：
*   **动作**：关闭“推荐算法”、“个性化皮肤”等非核心接口。
*   **结果**：腾出的资源全部倾斜给“主流程”。

### 维度 C: 基于配额 (Quotas)
适合 SaaS 平台。
*   租户 A 如果每小时额度用完，其后续请求返回 403，不再消耗其他租户的共享池。

---

## 3. 实现策略

### 1. 动态自修复 (Self-healing)
代码监听 JVM 关键指标：
```java
if (SystemInfo.getCpuLoad() > 0.9) {
    throttlingRegistry.enableStrictMode(); // 开启严耕模式，丢弃非核心流量
}
```

### 2. 漏桶算法变种
在入队时，根据优先级（Priority）排序。低优请求在流量高峰期会被排在队尾甚至直接溢出丢弃。

---

## 4. 关键：优雅的告知

既然是“差别对待”，就要让受限者明白原因：

*   **告知用户**：不要只写“内部错误”。告诉他“由于当前访问量大，你作为普通用户需要排队，开通会员立即加速”。
*   **告知开发者**：监控面板上要能区分正常流量和被节流流量。

---

## 5. 注意事项

*   **过度节流带来的反感**：如果由于系统设计缺陷导致付费用户也频繁被节流，那是业务自杀行为。
*   **计算开销**：由于要实时查询用户等级、配额，节流逻辑本身不能太慢，应尽量放在网关层并缓存级别信息。

## 6. 总结
分级节流是架构师的 **“经济学模型”**。
*   **核心逻辑**：资源永远不够，好钢必须用在刀刃上。
*   **一句话口诀**：分清主次保核心，分级限速保公平。
