# Blue-Green Deployment (蓝绿部署)

一种旨在通过提供两套完全相同的生产环境（蓝环境和绿环境）来实现 **“零停机发布”** 和 **“瞬间快速回滚”** 的高可用部署模式。

## 1. 痛点：高风险的“覆盖更新”

在没有蓝绿部署之前，发布新版本就像做手术：

```bash
[执行发布脚本] -> 停止服务 -> 拷贝新 Jar 包 -> 覆盖旧包 -> 启动服务 -> 冒烟测试
```

**灾难场景**：
1.  **发布期间停机**：用户在服务重启的 30 秒内（或更长）无法使用系统，产生 `502 Bad Gateway`。
2.  **回滚困难**：一旦上线后发现 V2.0 有严重 Bug，必须手动停止、删掉新包、找回老包备份、重新启动。这期间产生的损失是巨大的。
3.  **心虚上线**：测试环境过得去，不代表生产环境那复杂的流量下也是对的。

---

## 2. 解决方案：两套环境，一键切流

我们将生产环境物理上克隆为两份，标记为 **“蓝色 (Blue)”** 和 **“绿色 (Green)”**。

### 标准运行状态
*   **蓝环境 (当前线上线)**：运行 v1.0，承接 100% 的真实用户流量。
*   **绿环境 (空闲/待命)**：处于开启状态但不接待真实请求。

### 发布流程
1.  **部署到绿**：将 v2.0 代码部署到空闲的绿色环境。
2.  **内部验证**：QA 或开发人员通过内网直连绿环境的 IP 进行全量测试。此时由于它不承接外网流量，即便挂了也不影响用户。
3.  **切流 (Switch)**：测试通过。将负载均衡器（Nginx/SLB）的路由目标**瞬间**从蓝改为绿。
4.  **观察与回退**：流量切过去后观察日志。如果发现不对，瞬间切回蓝色环境。
5.  **结束**：若绿环境稳定运行几小时，则将蓝色环境归位，准备下次发布。

---

## 3. 实现策略

### 技术栈要求
*   **自动化脚本**：必须有能力一键完成两套环境的部署。
*   **负载均衡层**：Nginx/OpenResty 或云厂商配置中心需要支持热重载（Reload）。

### 数据库的处理 (核心挑战)
这是蓝绿部署最考验功力的地方：新老版本共享一个数据库吗？
*   **策略 A: 共享 DB (主流)**：v2.0 的业务逻辑必须兼容 v1.0 的表结构。即：**字段只能增，不能直接删或改名**。
*   **策略 B: 分库同步**：给蓝绿各配一个 DB。通过实时同步（如 Canal）同步数据。

---

## 4. 关键：什么时候该用它？
*   **绝对不能停机**：如电商、支付、金融核心系统。
*   **资源充裕**：你必须承担得起双倍的服务器服务器费用。

---

## 5. 常见挑战与注意事项

1.  **长连接断开**：切流时会导致 WebSocket 或活动中的长连接断开。
2.  **Session 丢失**：如果 Session 存在本地，用户切到新环境会导致重新登录。必须使用 Redis 存储分布式 Session。

## 6. 总结
蓝绿部署是架构师的 **“安全带”**。
*   **核心逻辑**：通过物理冗余换取上线的绝对冷静。
*   **一句话口诀**：两套环境两手备，切流瞬间定成败。
